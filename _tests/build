#!/bin/bash

# Exit on first failing command.
set -e
# Echo commands to console.
set -x
# Exit on unset variable.
set -u

# Execute Frontmatter Tests
BUNDLE_GEMFILE=Gemfile bundle exec jekyll yml-test

_tests/lint-markdown
_tests/check-trailing-whitespace

# Build production site.
BUNDLE_GEMFILE=Gemfile JEKYLL_ENV=production bundle exec jekyll build \
  --config _config.yml,_config_prod.yml

_tests/check-google-analytics-token
_tests/lint-html "$@"

# Make sure large twitter cards are being generated.
if ! egrep "\"twitter:card.*summary_large_image\"" _site/ -R; then
  echo "ERROR: Large Twitter cards didn't appear in prod build!";
  exit 1;
fi

# Check that Amazon links have the right affiliate ID.
if [ "${1-}" = "--quick" ]; then
  echo "Skipping Amazon link check..."
else
  echo "Checking Amazon links..."
  ./_tests/check_amazon_links
fi
