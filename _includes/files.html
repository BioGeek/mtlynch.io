{% comment %}
  Files Embed Include

  This include file makes it possible to easily embed a file from the "files"
  collection within a page, post, or layout. The file will be displayed inside
  a pre block and include a download link underneath.

  @param {string} "title" - the yml meta field for title in the download file
  @param {string} "language" - the coding language used for syntax highlighting
{% endcomment %}

{% comment %}
  Determine correct collection based on language param.
{% endcomment %}
{% if include.language == "yml" or include.language == "yaml" %}
	{% assign files = site.ymls | where: 'title', include.title %}
{% else %}
	{% assign files = site.files | where: 'title', include.title %}
{% endif %}

{% comment %}
  Determine syntax highlighting language (defaults to null).
{% endcomment %}
{% assign lang_highlight = "" %}
{% if include.language %}
	{% assign lang_highlight = include.language %}
{% endif %}

{% comment %} Initialize file count. {% endcomment %}
{% assign file_count = 0 %}

{% for file in files %}

  {% comment %}
    Determine which page includes this file. It will match the name of the
    folder that contains the file, for example:

      _files/sia-nextcloud/Dockerfile.sia
             ^^^^^^^^^^^^^
             Matching page slug
  {% endcomment %}
  {% assign file_path_parts = file.relative_path | split: '/' %}
  {% assign matching_page_slug = file_path_parts[1] %}

  {% comment %}
    If we're not in the page that includes this file, skip it.
  {% endcomment %}
  {% if matching_page_slug != page.slug %}
    {% continue %}
  {% endif %}

  {% comment %}
    Determine the relative URL of the file as it will appear on the site.
  {% endcomment %}
  {% assign file_relative_url = file.relative_path | replace: '_files/', '/files/' | replace: '_ymls/', '/files/' %}
  {% comment %}
    YAML files are a special case because the files are not stored with their
    extensions. We need to add the extensions back, so a URL like:

      /files/sia-nextcloud/docker-compose

    becomes:

      /files/sia-nextcloud/docker-compose.yml

    Note that we must normalize the extension to .yml, even if the language is
    set to "yaml" because the embed will fail if it's "yaml".
  {% endcomment %}
  {% if include.language == 'yml' or include.language == 'yaml' %}
    {% assign file_relative_url = file_relative_url | append: '.yml' %}
  {% endif %}

```{{ lang_highlight }}
{{ file.content -}}
```
{:.code-block-tab}

<div class="clearfix">
  <a href="{{ file_relative_url }}" download class="btn--small code-tab">download raw</a>
</div>
  {% assign file_count = file_count | plus: 1 %}

{% endfor %}

{% if file_count > 1 %}
  {% comment %}
    If there has been more than 1 file with the same title found, then raise an
    error as this is likely not intentional.
  {% endcomment %}
  {{ "Multiple file includes with the same title, "
    | append: include.title
    | append: ", have been found."
    | raise_exception: "warning" }}
{% elsif file_count == 0 %}
  {% comment %}
    If there have been NO files found in the subdirectory that match the title,
    then raise an error.
  {% endcomment %}
  {{ "Zero file includes matched the title, "
    | append: include.title
    | append: ".  Please check the file include's title and directory again."
    | raise_exception: "warning" }}
{% endif %}
